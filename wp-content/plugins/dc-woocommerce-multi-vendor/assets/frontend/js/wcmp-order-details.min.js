jQuery(function(d){var _={init:function(){d("#wcmp-order-details").on("click","button.refund-items",this.refund_items).on("click",".cancel-action",this.cancel).on("click","button.do-api-refund, button.do-manual-refund",this.refunds.do_refund).on("change",".refund input.refund_line_total, .refund input.refund_line_tax",this.refunds.input_changed).on("change keyup",".wcmp-order-refund-items #refund_amount",this.refunds.amount_changed).on("change","input.refund_order_item_qty",this.refunds.refund_quantity_changed).on("change","input.quantity",this.quantity_changed).on("click","#order_status a",this.order_status_changed).on("keyup change",".split-input :input",function(){var t=d(this).parent().prev().find(":input");t&&(""===t.val()||t.is(".match-total"))&&t.val(d(this).val()).addClass("match-total")}).on("keyup",".split-input :input",function(){d(this).removeClass("match-total")})},block:function(){d("#wcmp-order-details").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){d("#wcmp-order-details").unblock()},quantity_changed:function(){var n=d(this).closest("tr.item"),o=d(this).val(),_=d(this).attr("data-qty"),t=d("input.line_total",n),a=d("input.line_subtotal",n),e=accounting.unformat(t.attr("data-total"),wcmp_order_details_js_script_data.mon_decimal_point)/_;t.val(parseFloat(accounting.formatNumber(e*o,wcmp_order_details_js_script_data.rounding_precision,"")).toString().replace(".",wcmp_order_details_js_script_data.mon_decimal_point));var r=accounting.unformat(a.attr("data-subtotal"),wcmp_order_details_js_script_data.mon_decimal_point)/_;a.val(parseFloat(accounting.formatNumber(r*o,wcmp_order_details_js_script_data.rounding_precision,"")).toString().replace(".",wcmp_order_details_js_script_data.mon_decimal_point)),d("input.line_tax",n).each(function(){var t=d(this),a=t.data("tax_id"),e=accounting.unformat(t.attr("data-total_tax"),wcmp_order_details_js_script_data.mon_decimal_point)/_,r=d('input.line_subtotal_tax[data-tax_id="'+a+'"]',n),i=accounting.unformat(r.attr("data-subtotal_tax"),wcmp_order_details_js_script_data.mon_decimal_point)/_;0<e&&t.val(parseFloat(accounting.formatNumber(e*o,wcmp_order_details_js_script_data.rounding_precision,"")).toString().replace(".",wcmp_order_details_js_script_data.mon_decimal_point)),0<i&&r.val(parseFloat(accounting.formatNumber(i*o,wcmp_order_details_js_script_data.rounding_precision,"")).toString().replace(".",wcmp_order_details_js_script_data.mon_decimal_point))}),d(this).trigger("quantity_changed")},order_status_changed:function(){var t=d(this).data("status"),a=d("#order_current_status").val(),e=d("#order_ID").val();if(d(this).parents(".change-status").find(".order-status-text").removeClass(function(t,a){return(a.match(/(^|\s)wc\S+/g)||[]).join(" ")}).addClass(t),a==t)return d(".change-status").removeClass("loaderOverlay"),d(".dropdown-order-statuses").removeClass("open"),!1;if("wc-cancelled"==t){if(!window.confirm(wcmp_order_details_js_script_data.i18n_do_cancel))return!1}else if("wc-cancelled"==a)return!1;d(".change-status").addClass("loaderOverlay");var r={action:"wcmp_order_status_changed",order_id:e,selected_status:t};d.post(wcmp_order_details_js_script_data.ajax_url,r,function(t){t&&(d(".order_status_lbl").html(""),"wc-cancelled"==t.status_key&&d(".dropdown-order-statuses").hide(),d(".order_status_lbl").html(t.status_name),d("#order_current_status").val(t.status_key),d(".change-status").removeClass("loaderOverlay"))})},refund_items:function(){return d("div.wcmp-order-refund-items").slideDown(),d("div.wcmp-order-data-row-toggle").not("div.wcmp-order-refund-items").slideUp(),d("div.wcmp-order-totals-items").slideUp(),d("#wcmp-order-details").find("div.refund").show(),!1},cancel:function(){return d("div.wcmp-order-data-row-toggle").not("div.wcmp-order-actions").slideUp(),d("div.wcmp-order-actions").slideDown(),d("div.wcmp-order-totals-items").slideDown(),d("#wcmp-order-details").find("div.refund").hide(),!1},refunds:{do_refund:function(){if(_.block(),window.confirm(wcmp_order_details_js_script_data.i18n_do_refund)){var t=d("input#refund_amount").val(),a=d("input#refund_reason").val(),e=d("input#refunded_amount").val(),r={},i={},n={};d(".refund input.refund_order_item_qty").each(function(t,a){d(a).closest("tr").data("order_item_id")&&a.value&&(r[d(a).closest("tr").data("order_item_id")]=a.value)}),d(".refund input.refund_line_total").each(function(t,a){d(a).closest("tr").data("order_item_id")&&(i[d(a).closest("tr").data("order_item_id")]=accounting.unformat(a.value,wcmp_order_details_js_script_data.mon_decimal_point))}),d(".refund input.refund_line_tax").each(function(t,a){if(d(a).closest("tr").data("order_item_id")){var e=d(a).data("tax_id");n[d(a).closest("tr").data("order_item_id")]||(n[d(a).closest("tr").data("order_item_id")]={}),n[d(a).closest("tr").data("order_item_id")][e]=accounting.unformat(a.value,wcmp_order_details_js_script_data.mon_decimal_point)}});var o={action:"wcmp_do_refund",order_id:wcmp_order_details_js_script_data.post_id,refund_amount:t,refunded_amount:e,refund_reason:a,line_item_qtys:JSON.stringify(r,null,""),line_item_totals:JSON.stringify(i,null,""),line_item_tax_totals:JSON.stringify(n,null,""),api_refund:d(this).is(".do-api-refund"),restock_refunded_items:d("#restock_refunded_items:checked").length?"true":"false",security:wcmp_order_details_js_script_data.order_item_nonce};d.post(wcmp_order_details_js_script_data.ajax_url,o,function(t){!0===t.success?window.location.href=window.location.href:(window.alert(t.data.error),window.location.href=window.location.href,_.unblock())})}else _.unblock()},input_changed:function(){var e=0;d(".woocommerce_order_items").find("tr.item, tr.fee, tr.shipping").each(function(){d(this).find(".refund input:not(.refund_order_item_qty)").each(function(t,a){e+=parseFloat(accounting.unformat(d(a).val()||0,wcmp_order_details_js_script_data.mon_decimal_point))})}),d("#refund_amount").val(accounting.formatNumber(e,wcmp_order_details_js_script_data.currency_format_num_decimals,"",wcmp_order_details_js_script_data.mon_decimal_point)).change()},amount_changed:function(){var t=accounting.unformat(d(this).val(),wcmp_order_details_js_script_data.mon_decimal_point);d("button .wc-order-refund-amount .amount").text(accounting.formatMoney(t,{symbol:wcmp_order_details_js_script_data.currency_format_symbol,decimal:wcmp_order_details_js_script_data.currency_format_decimal_sep,thousand:wcmp_order_details_js_script_data.currency_format_thousand_sep,precision:wcmp_order_details_js_script_data.currency_format_num_decimals,format:wcmp_order_details_js_script_data.currency_format}))},refund_quantity_changed:function(){var i=d(this).closest("tr.item"),n=i.find("input.quantity").val(),o=d(this).val(),t=d("input.line_total",i),a=d("input.refund_line_total",i),e=accounting.unformat(t.attr("data-total"),wcmp_order_details_js_script_data.mon_decimal_point)/n;a.val(parseFloat(accounting.formatNumber(e*o,wcmp_order_details_js_script_data.rounding_precision,"")).toString().replace(".",wcmp_order_details_js_script_data.mon_decimal_point)).change(),d(".refund_line_tax",i).each(function(){var t=d(this),a=t.data("tax_id"),e=d('input.line_tax[data-tax_id="'+a+'"]',i),r=accounting.unformat(e.data("total_tax"),wcmp_order_details_js_script_data.mon_decimal_point)/n;0<r?t.val(parseFloat(accounting.formatNumber(r*o,wcmp_order_details_js_script_data.rounding_precision,"")).toString().replace(".",wcmp_order_details_js_script_data.mon_decimal_point)).change():t.val(0).change()}),0<o?d("#restock_refunded_items").closest("tr").show():(d("#restock_refunded_items").closest("tr").hide(),d(".woocommerce_order_items input.refund_order_item_qty").each(function(){0<d(this).val()&&d("#restock_refunded_items").closest("tr").show()})),d(this).trigger("refund_quantity_changed")}}},t={init:function(){d(".date-picker").datepicker({defaultDate:"",dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0}),d(".order_download_permissions").on("click","button.grant_access",this.grant_access).on("click","button.revoke_access",this.revoke_access).on("click","#copy-download-link",this.copy_link).on("aftercopy","#copy-download-link",this.copy_success).on("aftercopyfailure","#copy-download-link",this.copy_fail)},grant_access:function(){var t=d("#grant_access_id").val();if(t){d(".order_download_permissions").block({message:null,overlayCSS:{background:"#fff",opacity:.6}});var a={action:"wcmp_grant_access_to_download",product_ids:t,loop:d(".order_download_permissions .wc-metabox").length,order_id:wcmp_order_details_js_script_data.post_id,security:wcmp_order_details_js_script_data.grant_access_nonce};return d.post(wcmp_order_details_js_script_data.ajax_url,a,function(t){t?d(".order_download_permissions .wc-metaboxes").append(t):window.alert(wcmp_order_details_js_script_data.i18n_download_permission_fail),d(document.body).trigger("wc-init-datepickers"),d("#grant_access_id").val("").change(),d(".order_download_permissions").unblock()}),!1}},revoke_access:function(){if(window.confirm(wcmp_order_details_js_script_data.i18n_permission_revoke)){var t=d(this).parent().parent(),a=d(this).attr("rel").split(",")[0],e=d(this).attr("rel").split(",")[1],r=d(this).data("permission_id");if(0<a){d(t).block({message:null,overlayCSS:{background:"#fff",opacity:.6}});var i={action:"woocommerce_revoke_access_to_download",product_id:a,download_id:e,permission_id:r,order_id:wcmp_order_details_js_script_data.post_id,security:wcmp_order_details_js_script_data.revoke_access_nonce};d.post(wcmp_order_details_js_script_data.ajax_url,i,function(){d(t).fadeOut("300",function(){d(t).remove()})})}else d(t).fadeOut("300",function(){d(t).remove()})}return!1},copy_link:function(t){wcClearClipboard(),wcSetClipboard(d(this).attr("href"),d(this)),t.preventDefault()},copy_success:function(){d(this).tipTip({attribute:"data-tip",activation:"focus",fadeIn:50,fadeOut:50,delay:0}).focus()},copy_fail:function(){d(this).tipTip({attribute:"data-tip-failed",activation:"focus",fadeIn:50,fadeOut:50,delay:0}).focus()}};_.init(),t.init()});